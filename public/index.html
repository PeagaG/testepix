<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerar PIX</title>
  <style>
    :root {
      color-scheme: light dark;
      --border-radius: 12px;
      --border-color: rgba(0, 0, 0, 0.12);
      --ok: #0a7a3a;
      --err: #b00020;
      --bg-muted: rgba(0, 0, 0, 0.04);
      --transition: 150ms ease;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
      max-width: 760px;
      margin: 40px auto;
      padding: 0 16px 64px;
      line-height: 1.45;
    }

    header {
      margin-bottom: 24px;
    }

    h1 {
      margin-bottom: 4px;
    }

    p.subtle {
      margin: 0;
      font-size: 15px;
      color: rgba(0, 0, 0, 0.65);
    }

    .card {
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin: 20px 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(6px);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
    }

    fieldset {
      border: none;
      padding: 0;
      margin: 0 0 18px;
    }

    fieldset:last-of-type {
      margin-bottom: 0;
    }

    legend {
      font-weight: 600;
      margin-bottom: 12px;
    }

    label {
      display: block;
      margin: 10px 0 4px;
      font-weight: 500;
    }

    input,
    button,
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      transition: box-shadow var(--transition), border-color var(--transition);
    }

    textarea {
      resize: vertical;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    button {
      cursor: pointer;
      font-weight: 600;
      border: none;
      background: #2563eb;
      color: #fff;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    button.secondary {
      background: var(--bg-muted);
      color: inherit;
      border: 1px solid var(--border-color);
    }

    button[disabled] {
      opacity: 0.6;
      cursor: progress;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }

    .ok {
      color: var(--ok);
    }

    .err {
      color: var(--err);
      white-space: pre-wrap;
    }

    .qr {
      display: grid;
      place-items: center;
      margin-top: 20px;
    }

    .qr img {
      max-width: min(260px, 100%);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      padding: 12px;
      background: #fff;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }

    code.inline {
      font-size: 0.95em;
      padding: 2px 6px;
      border-radius: 6px;
      background: var(--bg-muted);
    }

    small.helper {
      display: block;
      margin-top: 4px;
      color: rgba(0, 0, 0, 0.55);
    }
  </style>
</head>
<body>
  <header>
    <h1>Gerar PIX</h1>
    <p class="subtle">
      Servidor: <code class="inline" id="health">checando…</code>
      · Token: <code class="inline" id="tokenStatus">desconhecido</code>
    </p>
  </header>

  <div class="card">
    <form id="pixForm" novalidate>
      <fieldset>
        <legend>Dados do pagamento</legend>
        <label for="valor">Valor (R$)</label>
        <input id="valor" type="text" inputmode="decimal" placeholder="10,00" value="10,00" autocomplete="off" required />
        <small class="helper">Informe apenas números, vírgula e ponto. Ex: <code class="inline">10,50</code></small>

        <div class="row">
          <div>
            <label for="webhook">Webhook (opcional)</label>
            <input id="webhook" type="url" placeholder="https://seusite.com/webhook" />
          </div>
          <div>
            <label for="splitRules">Split rules (JSON)</label>
            <textarea id="splitRules" rows="3" placeholder='[{"recipient_code":"...","percentage":50}]'></textarea>
            <small class="helper">Deixe em branco se não utilizar split.</small>
          </div>
        </div>
      </fieldset>

      <div class="actions">
        <button id="btnSubmit" type="submit">Gerar QR Code</button>
        <button id="btnLimpar" class="secondary" type="button">Limpar formulário</button>
      </div>
    </form>
  </div>

  <div id="resultado" class="card" style="display:none">
    <p><strong>Status:</strong> <span id="status">—</span></p>
    <p id="valorResumo" class="subtle"></p>
    <div class="qr" id="qrWrapper" hidden>
      <img id="qrImg" alt="QR Code PIX" />
    </div>
    <label style="margin-top:12px" for="qrText">Copia e Cola</label>
    <textarea id="qrText" rows="5" readonly></textarea>
    <div class="actions">
      <button id="btnCopiar" type="button">Copiar código</button>
      <button id="btnNovo" class="secondary" type="button">Gerar outro</button>
    </div>
    <p id="erro" class="err" style="display:none"></p>
  </div>

<script type="module">
  const $ = (id) => document.getElementById(id);

  const els = {
    form: $("pixForm"),
    submit: $("btnSubmit"),
    clear: $("btnLimpar"),
    novo: $("btnNovo"),
    copiar: $("btnCopiar"),
    resultado: $("resultado"),
    status: $("status"),
    erro: $("erro"),
    qrImg: $("qrImg"),
    qrWrapper: $("qrWrapper"),
    qrText: $("qrText"),
    valor: $("valor"),
    valorResumo: $("valorResumo"),
    webhook: $("webhook"),
    split: $("splitRules"),
    health: $("health"),
    tokenStatus: $("tokenStatus"),
  };

  const currencyFormatter = new Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL",
    minimumFractionDigits: 2,
  });

  const setLoading = (isLoading) => {
    els.submit.disabled = isLoading;
    els.submit.textContent = isLoading ? "Gerando…" : "Gerar QR Code";
  };

  const showError = (message) => {
    els.status.textContent = "erro";
    els.erro.style.display = "block";
    els.erro.textContent = message;
  };

  const reaisParaCentavos = (txt) => {
    if (!txt) return 0;
    const normalized = txt
      .toString()
      .trim()
      .replace(/\s+/g, "")
      .replace(/\./g, "")
      .replace(",", ".")
      .replace(/[^\d.\-]/g, "");

    const value = Number.parseFloat(normalized);
    if (!Number.isFinite(value)) return NaN;
    return Math.round(value * 100);
  };

  const parseSplitRules = (text) => {
    const trimmed = text.trim();
    if (!trimmed) return [];
    try {
      const parsed = JSON.parse(trimmed);
      if (!Array.isArray(parsed)) {
        throw new Error("O JSON precisa ser um array.");
      }
      return parsed;
    } catch (err) {
      throw new Error(`Split rules inválidas: ${err.message}`);
    }
  };

  const resetResultado = () => {
    els.resultado.style.display = "none";
    els.erro.style.display = "none";
    els.erro.textContent = "";
    els.status.textContent = "—";
    els.qrWrapper.hidden = true;
    els.qrImg.src = "";
    els.qrText.value = "";
    els.valorResumo.textContent = "";
  };

  const atualizarHealth = async () => {
    try {
      const response = await fetch("/health");
      if (!response.ok) throw new Error("Falha no healthcheck");
      const payload = await response.json();
      els.health.textContent = payload.ok ? "OK" : "indisponível";
      els.tokenStatus.textContent = payload.hasToken ? "configurado" : "não configurado";
      els.tokenStatus.className = payload.hasToken ? "inline ok" : "inline err";
    } catch (err) {
      els.health.textContent = "indisponível";
      els.tokenStatus.textContent = "indisponível";
      els.tokenStatus.className = "inline err";
    }
  };

  els.form.addEventListener("submit", async (event) => {
    event.preventDefault();
    setLoading(true);
    els.resultado.style.display = "block";
    els.erro.style.display = "none";
    els.erro.textContent = "";
    els.status.textContent = "gerando…";
    els.qrWrapper.hidden = true;
    els.qrImg.removeAttribute("src");
    els.qrText.value = "";

    const valueInCents = reaisParaCentavos(els.valor.value);
    if (!Number.isFinite(valueInCents) || valueInCents <= 0) {
      setLoading(false);
      showError("Informe um valor válido maior que zero.");
      return;
    }

    let splitRules;
    try {
      splitRules = parseSplitRules(els.split.value);
    } catch (err) {
      setLoading(false);
      showError(err.message);
      return;
    }

    try {
      const response = await fetch("/pix", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          value: valueInCents,
          webhook_url: els.webhook.value.trim() || undefined,
          split_rules: splitRules,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        const reason = typeof data === "object" ? JSON.stringify(data, null, 2) : String(data);
        throw new Error(reason);
      }

      els.status.textContent = data.status ?? "ok";
      els.valorResumo.textContent = `Valor solicitado: ${currencyFormatter.format(valueInCents / 100)}`;

      if (data.qr_code_base64) {
        els.qrWrapper.hidden = false;
        els.qrImg.src = data.qr_code_base64;
      }

      if (data.qr_code) {
        els.qrText.value = data.qr_code;
      }

      if (!data.qr_code && !data.qr_code_base64) {
        showError("A API não retornou um QR Code.");
      }
    } catch (err) {
      showError(String(err.message || err));
    } finally {
      setLoading(false);
    }
  });

  els.copiar.addEventListener("click", async () => {
    const texto = els.qrText.value.trim();
    if (!texto) return;
    try {
      await navigator.clipboard.writeText(texto);
      window.alert("Código PIX copiado para a área de transferência!");
    } catch (err) {
      window.alert("Não foi possível copiar automaticamente. Copie manualmente.");
      console.warn("Clipboard copy failed", err);
    }
  });

  els.novo.addEventListener("click", () => {
    resetResultado();
    els.valor.focus();
  });

  els.clear.addEventListener("click", () => {
    els.form.reset();
    els.split.value = "";
    resetResultado();
  });

  atualizarHealth();
</script>
</body>
</html>
